(()=>{var t={573:t=>{(()=>{"use strict";var e,a={};e=a,Object.defineProperty(e,"__esModule",{value:!0}),e.SHOPIFY_THEME_APP_EXTENSION_ID=e.SHOPIFY_CLIENT_ID=e.DEVELOPMENT_PATH_PREFIX=e.GEOSERVICE_URL=e.APP_URL=e.NODE_ENV=void 0,e.NODE_ENV="production",e.APP_URL="https://skosm.klarna.com",e.GEOSERVICE_URL=`${e.APP_URL}/geolocation/v1`,e.DEVELOPMENT_PATH_PREFIX="",e.SHOPIFY_CLIENT_ID="4439684aa13a71f0befb66b3a308e7d4",e.SHOPIFY_THEME_APP_EXTENSION_ID="b95936a9-74b6-4a95-8103-6a1b6459c25e",t.exports=a})()}},e={};function a(r){var i=e[r];if(void 0!==i)return i.exports;var n=e[r]={exports:{}};return t[r](n,n.exports,a),n.exports}(()=>{"use strict";const t=(...t)=>{console.log("[klarna-osm]",...t)},e=t=>new Promise((e=>setTimeout(e,t))),r=()=>{if(!(document.currentScript instanceof HTMLScriptElement))return"unknown";const t=document.currentScript.src.split("/").at(-3);return`${"0.0.0"===t?"local:":""}${t}`||"unknown"},i=()=>Array.from(document.getElementsByTagName("klarna-placement"));var n=a(573);class o{constructor(){this.store=null}async getStore(){return this.store||this.fetchStore()}async fetchStore(){const t=o.constructUrl(),e=await fetch(t.toString(),{headers:{"x-app-blocks-version":r()}});return this.store=await e.json(),this.store}static constructUrl(){var t;const e=window.location.hostname,a=null===(t=window.Shopify)||void 0===t?void 0:t.shop,r=e!==a?e:"",i=new URL(("/app-blocks/v1/store",`${n.DEVELOPMENT_PATH_PREFIX}/app-blocks/v1/store`),n.APP_URL);return i.searchParams.set("defaultDomain",a),i.searchParams.set("customDomain",r),i}}async function s(){var t;const e=await fetch("/cart.json");if(!e.ok)throw new Error;return null!==(t=(await e.json()).total_price)&&void 0!==t?t:0}const c={"Europe/Vienna":"AT","Australia/Lord_Howe":"AU","Antarctica/Macquarie":"AU","Australia/Hobart":"AU","Australia/Currie":"AU","Australia/Melbourne":"AU","Australia/Sydney":"AU","Australia/Broken_Hill":"AU","Australia/Brisbane":"AU","Australia/Lindeman":"AU","Australia/Adelaide":"AU","Australia/Darwin":"AU","Australia/Perth":"AU","Australia/Eucla":"AU","Europe/Brussels":"BE","America/St_Johns":"CA","America/Halifax":"CA","America/Glace_Bay":"CA","America/Moncton":"CA","America/Goose_Bay":"CA","America/Blanc-Sablon":"CA","America/Toronto":"CA","America/Nipigon":"CA","America/Thunder_Bay":"CA","America/Iqaluit":"CA","America/Pangnirtung":"CA","America/Resolute":"CA","America/Atikokan":"CA","America/Rankin_Inlet":"CA","America/Winnipeg":"CA","America/Rainy_River":"CA","America/Regina":"CA","America/Swift_Current":"CA","America/Edmonton":"CA","America/Cambridge_Bay":"CA","America/Yellowknife":"CA","America/Inuvik":"CA","America/Creston":"CA","America/Dawson_Creek":"CA","America/Vancouver":"CA","America/Whitehorse":"CA","America/Dawson":"CA","Europe/Zurich":"CH","Europe/Prague":"CZ","Europe/Berlin":"DE","Europe/Busingen":"DE","Europe/Copenhagen":"DK","Europe/Madrid":"ES","Africa/Ceuta":"ES","Atlantic/Canary":"ES","Europe/Helsinki":"FI","Europe/Paris":"FR","Europe/Budapest":"HU","Europe/Rome":"IT","America/Mexico_City":"MX","America/Cancun":"MX","America/Merida":"MX","America/Monterrey":"MX","America/Matamoros":"MX","America/Mazatlan":"MX","America/Chihuahua":"MX","America/Ojinaga":"MX","America/Hermosillo":"MX","America/Tijuana":"MX","America/Santa_Isabel":"MX","America/Bahia_Banderas":"MX","Europe/Amsterdam":"NL","Arctic/Longyearbyen":"NO","Europe/Oslo":"NO","Europe/Warsaw":"PL","Europe/Lisbon":"PT","Atlantic/Madeira":"PT","Atlantic/Azores":"PT","Europe/Stockholm":"SE","Europe/Bratislava":"SK"},l="klarnaosm_user_locale";class u{static getCountryFromTimeZone(){var e;const{timeZone:a}=Intl.DateTimeFormat().resolvedOptions(),r=null!==(e=c[a])&&void 0!==e?e:null;return r||t("[getCountryFromTimeZone] unsupported country or time zone",{timeZone:a}),r}static async fetchUserCountry(){let e=u.getCachedUsersCountry();if(e)return t("Found users country in cache"),e;try{const t=new AbortController;setTimeout((()=>t.abort()),1500);const a=window.location.hostname,i=Shopify.shop,o=a!==i?a:"",s=new URL(n.GEOSERVICE_URL);s.searchParams.set("defaultDomain",i),s.searchParams.set("customDomain",o);const c=await fetch(s,{signal:t.signal,headers:{"x-app-blocks-version":r()}});if(!c.ok)throw new Error(c.statusText);e=(await c.json()).country}catch(e){return t("[getUsersCountry] Failed",e),t("[getUsersCountry] trying to parse from time zone"),this.getCountryFromTimeZone()}return e&&u.setCachedUsersCountry(e),e}static getCachedUsersCountry(){return localStorage.getItem(l)||null}static setCachedUsersCountry(e){t("Setting users country to cache",e),localStorage.setItem(l,e)}constructor(t){this.midLocales=null!=t?t:{}}static findLocale(e,a,r){var i,n;if(e){t("[getMatchingLocale] Valid locales for users country",e);const o=null!==(i=e[0])&&void 0!==i?i:null;let s="";if(a&&"undefined"!=typeof Shopify?(s=Shopify.locale,t("[getMatchingLocale] Using Shopify.locale",s)):navigator.language&&(s=navigator.language.slice(0,2),t("[getMatchingLocale] Using browser language",s)),s){const t=e.find((t=>t.startsWith(s)));if(t)return t}return r&&null!==(n=e.find((t=>t.startsWith("en"))))&&void 0!==n?n:o}return null}getMatchingLocale(e,a,r){if(!e||!this.midLocales)return t("[getMatchingLocale] Invalid data",e,this.midLocales),null;t("[getMatchingLocale] Available countries for merchant",r);const i=this.getFilteredLocales(r);t("[getMatchingLocale] Valid locales for merchant",i);const n=null==i?void 0:i[e];return u.findLocale(n,a,!0)}getFilteredLocales(t){if(!t)return this.midLocales;const e=new Set(t);return Object.keys(this.midLocales).reduce(((t,a)=>{var r;return e.has(a)&&(t[a]=null!==(r=this.midLocales[a])&&void 0!==r?r:[]),t}),{})}getMatchingLocaleWithMidLocales(e,a){if(!e||!this.midLocales||0===Object.keys(this.midLocales).length)return t("[getMatchingLocale] Invalid data",e,this.midLocales),null;const r=this.midLocales[e];return u.findLocale(r,a,!1)}}const d=u;class h{constructor(t){this.store=t}inject(){if(!this.isOSMScriptAlreadyInjected())try{this.injectKlarnaOSMScriptTag(),t("Klarna OSM Script Tag has been added successfully")}catch(e){t("Could not add script element",e)}}isOSMScriptAlreadyInjected(){return null!==document.getElementById("klarna-osm-script-tag")}logIfEmptyClientId(){this.store.client_id||t("Creating OSM script element without data-client-id. This will cause placements not to show up. Check your configuration of Klarna OSM on the Klarna Merchant Portal.")}injectKlarnaOSMScriptTag(){const t=this.createKlarnaOSMScriptTag(),e=document.querySelector("body");e.insertBefore(t,e.children[0])}createKlarnaOSMScriptTag(){this.logIfEmptyClientId();const t=document.createElement("script"),e=this.store.playground_active?"playground":"production";return t.id="klarna-osm-script-tag",t.async=!0,t.setAttribute("data-environment",e),t.src="https://js.klarna.com/web-sdk/v1/klarna.js",t.setAttribute("data-client-id",this.store.client_id),t}}class m{static getVariantIdFromQueryString(){const t=new URLSearchParams(window.location.search).get("variant");return t?Number.parseInt(t,10):null}constructor(t,e){this.store=t,this.productVariants=e,this.localeService=new d(t.mid_locales)}async init(){var t;window.klarna_OSMP=window.klarna_OSMP||{},window.klarna_OSMP.updaterId=null!==(t=window.klarna_OSMP.updaterId)&&void 0!==t?t:0,this.injectOnSiteScript(),await this.initPurchaseAmountIfCartOrProductPage(),this.listenForInputChange()}injectOnSiteScript(){new h(this.store).inject()}async initPurchaseAmountIfCartOrProductPage(){["cart","product"].includes(this.currentPageType)&&await this.updatePurchaseAmount()}listenForInputChange(){"cart"===this.currentPageType&&this.updatePlacementsOnDomMutations(),"product"===this.currentPageType&&new MutationObserver((e=>{i().forEach((e=>{const a=String(this.getDataPurchaseAmount()||0),r=e.getAttribute("data-purchase-amount");a!==e.getAttribute("data-purchase-amount")&&(t(`amount changed from ${r} to ${a}`),e.setAttribute("data-purchase-amount",a))}))})).observe(document.body,{childList:!0,subtree:!0})}updatePlacementsOnDomMutations(){new MutationObserver(function(t,e){let a=!1;return function(){a||(a=!0,t(),setTimeout((()=>{a=!1}),1e3))}}((async()=>{window.klarna_OSMP.updaterId+=1;const t=window.klarna_OSMP.updaterId,a=[void 0,void 0,await s()];let r=5;const i=async()=>{const t=await s();return!!a.some((e=>e!==t))&&(await this.updatePurchaseAmount(t),a.shift(),a.push(t),!0)};for(;r>0&&t===window.klarna_OSMP.updaterId;)r-=1,await e(1e3),await i()}))).observe(document.body,{childList:!0,subtree:!0})}async updatePurchaseAmount(e=""){const a=i();let r=e;r||("cart"===this.currentPageType?r=await s():"product"===this.currentPageType&&(r=this.getDataPurchaseAmount())),t("Updating placements with new amount",{placements:a,purchaseAmount:r}),a.forEach((t=>{t.setAttribute("data-purchase-amount",String(r))}))}}class p extends m{constructor(t,e){super(t,e.productVariants),this.data=e,this.currentPageType=e.templateName}async init(){var e,a;const r=this.getKlarnaPlacement(),i=await this.fetchLocale();if(!i)return t("Locale not found, removing placement ",this.data.selector),void r.remove();r.setAttribute("data-locale",i),r.setAttribute("data-purchase-amount",this.getPurchaseAmount()),"product"===this.currentPageType&&"0"===this.getPurchaseAmount()&&(null===(e=this.store.dynamic_placements)||void 0===e?void 0:e.includes(r.getAttribute("data-key")||""))&&(t("[AppBlocksInject] using fallback placement",this.store.fallback_placement),r.setAttribute("data-key",this.store.fallback_placement)),r.setAttribute("data-preloaded","true"),r.setAttribute("data-integration-style","app-blocks");const n=Number.isNaN(this.data.topPadding)?0:this.data.topPadding,o=Number.isNaN(this.data.bottomPadding)?0:this.data.bottomPadding;(+n>0||+o>0)&&(null===(a=document.getElementById(`shopify-block-${this.data.selector.slice(12)}`))||void 0===a||a.setAttribute("style",`padding: ${n}px 0px ${o}px 0px;`)),await super.init()}getPurchaseAmount(){var t;return"product"===this.currentPageType?this.data.variantPrice:"cart"===this.currentPageType?this.data.cartPrice:(null===(t=window.Shopify)||void 0===t?void 0:t.designMode)?"10998":"0"}async fetchLocale(){var e,a,r,i,n,o,s;if((null===(e=window.Shopify)||void 0===e?void 0:e.designMode)&&this.data.localeFallback)return t("[fetchLocale] using manual locale in design mode",this.data),this.data.localeFallback.trim();if(null===(a=window.Shopify)||void 0===a?void 0:a.designMode){const e=null===(r=this.store.mid_locales)||void 0===r?void 0:r[null===(i=window.Shopify)||void 0===i?void 0:i.country],a=e?[e]:Object.values(null!==(n=this.store.mid_locales)&&void 0!==n?n:{});let c=null!==(s=null===(o=a[0])||void 0===o?void 0:o[0])&&void 0!==s?s:null;for(const e of a)for(const a of e)if(a.startsWith(this.data.shopLocale)){t("[fetchLocale] using locale for design mode",{locale:a,midLocales:this.store.mid_locales}),c=a;break}return c}if("manual"===this.data.localeOption&&this.data.localeFallback)return t("[fetchLocale] using manual locale"),this.data.localeFallback.trim();if("geolocation"===this.data.localeOption){t("[fetchLocale] using geolocation");const e=await d.fetchUserCountry(),a=this.localeService.getMatchingLocaleWithMidLocales(e,!0);return t("got matching locale",{usersCountry:e,matchingLocale:a,midLocales:this.store.mid_locales}),a}return null}getDataPurchaseAmount(){var t,e,a,r,i,n,o,s;let c=null;const l=m.getVariantIdFromQueryString();return l&&(c=null===(t=this.productVariants)||void 0===t?void 0:t.find((t=>t.id===l))),c?c.price:null!==(s=null!==(i=null===(r=null===(a=null===(e=this.productVariants)||void 0===e?void 0:e.filter((t=>t.available)))||void 0===a?void 0:a[0])||void 0===r?void 0:r.price)&&void 0!==i?i:null===(o=null===(n=this.productVariants)||void 0===n?void 0:n[0])||void 0===o?void 0:o.price)&&void 0!==s?s:0}getKlarnaPlacement(){const t=document.getElementById(this.data.selector);if(!t)throw new Error("Could not get klarna placement element");return t}}t("app blocks loaded"),t("Version:",r());const A=window.appBlockPlacements||[];window.klarnaAppBlocksManager||(window.klarnaAppBlocksManager=new class{async pushPlacement(t){const e=await this.storeService.getStore();await new p(e,t).init()}constructor(t){this.placements=t,this.storeService=new o,this.push=this.pushPlacement.bind(this),this.placements.forEach(this.push)}}(A))})()})();